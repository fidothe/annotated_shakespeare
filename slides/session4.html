<html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8" /><meta name="localStorage.key" content="slideno" /><title>Practical Web Applications</title><script type="text/javascript" language="javascript" src="js/jquery-1.6.2.min.js"></script><script type="text/javascript" language="javascript" src="js/jquery-ui-1.8.16.custom.min.js"></script><script type="text/javascript" language="javascript" src="js/jquery-timers-1.2.js"></script><script type="text/javascript" language="javascript" src="js/jquery.ba-hashchange.min.js"></script><script type="text/javascript" language="javascript" src="js/slides.js"></script><link type="text/css" rel="stylesheet" href="css/ui-lightness/jquery-ui-1.8.16.custom.css" /><link type="text/css" rel="stylesheet" href="css/slides.css" /></head><body><div class="foil titlefoil"><div class="page"><div class="header"><h1>Practical Web Applications</h1><h2>20 September 2012</h2></div><div class="body"><h1>Session Four</h1><div class="authorgroup"><div class="author"><h2><span class="personname"><span class="firstname">Lauren</span> <span class="surname">Wood</span></span></h2><h3><span class="orgname">Textuality Services, Inc.</span></h3></div><div class="author"><h2><span class="personname"><span class="firstname">Matt</span> <span class="surname">Patterson</span></span></h2><h3><span class="orgname">Constituent Parts, Ltd.</span></h3></div><div class="author"><h2><span class="personname"><span class="firstname">Norman </span> <span class="surname">Walsh</span></span></h2><h3><span class="orgname">MarkLogic</span></h3></div><div class="author"><h2><span class="personname"><span class="firstname">Paul</span> <span class="surname">Downey</span></span></h2><h3><span class="orgname">GDS</span></h3></div></div><div class="legalnotice"><p>Alpha by first name</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Agenda</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><ul class="toc"><li><a href="#1">What do we need in order to allow people to comment on an Act?</a></li><li><a href="#5"></a></li><li><a href="#7">Introducing DataMapper</a></li><li><a href="#16">POSTing data back to the app</a></li><li><a href="#19">Processing POST data</a></li><li><a href="#26">Displaying the results</a></li></ul></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div></div></div><div class="foil titlefoil foilgroup"><div class="page"><div class="header"><h1>What do we need in order to allow people to comment on an Act?</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">1</div></div></div><div class="foil"><div class="page"><div class="header"><h1>An idea of what goes into a Comment</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="itemizedlist"><ul><li><p>The text of the comment</p></li><li><p>Who left the comment</p></li><li><p>The thing being commented on</p></li></ul></div></div><div class="foil-notes"><div class="foilinset"><div class="itemizedlist"><ul><li><p>The text of the comment</p></li><li><p>Who left the comment</p></li><li><p>The thing being commented on</p></li></ul></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">2</div></div></div><div class="foil"><div class="page"><div class="header"><h1>A way of storing the Comment</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>Let's use a relational database</p><p>(We'll use SQLite, because it's really easy.)</p><div class="itemizedlist"><ul><li><p>Reliably generate SQL to insert or update a comment</p></li></ul></div></div><div class="foil-notes"><div class="foilinset"><p>Let's use a relational database</p><p>(We'll use SQLite, because it's really easy.)</p><div class="itemizedlist"><ul><li><p>Reliably generate SQL to insert or update a comment</p></li></ul></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">3</div></div></div><div class="foil"><div class="page"><div class="header"><h1>A way of getting a Comment back</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>There's no point being able to store something if you can't retrieve it...</p><div class="itemizedlist"><ul><li><p>Reliably generate SQL to retrieve a comment</p></li><li><p>A way of turning a SQL result set into something we can use in our app code</p></li></ul></div></div><div class="foil-notes"><div class="foilinset"><p>There's no point being able to store something if you can't retrieve it...</p><div class="itemizedlist"><ul><li><p>Reliably generate SQL to retrieve a comment</p></li><li><p>A way of turning a SQL result set into something we can use in our app code</p></li></ul></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">4</div></div></div><div class="foil titlefoil foilgroup"><div class="page"><div class="header"><h1></h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">5</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Modelling comments</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>Intrinsic features</p><div class="itemizedlist"><ul><li><p>Comment text</p></li></ul></div><p>Relationships</p><div class="itemizedlist"><ul><li><p>The thing being commented on</p></li><li><p>The commenter</p></li></ul></div></div><div class="foil-notes"><div class="foilinset"><p>Intrinsic features</p><div class="itemizedlist"><ul><li><p>Comment text</p></li></ul></div><p>Relationships</p><div class="itemizedlist"><ul><li><p>The thing being commented on</p></li><li><p>The commenter</p></li></ul></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">6</div></div></div><div class="foil titlefoil foilgroup"><div class="page"><div class="header"><h1>Introducing DataMapper</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">7</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Object persistence patterns</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>Data persistence used to mean constructing SQL queries by hand and 
        executing <code class="code">SELECT</code>, <code class="code">INSERT</code>, or <code class="code">UPDATE</code>
        queries directly from your web app controller.</p><p>More recently, persistence patterns which remove the responsibility
        for writing SQL have emerged.</p><p>Martin Fowler covered several of these in his book [<span class="citation">Patterns of Enterprise Application Architecture</span>].</p><p>Two of those, <em>Active Record</em> and <em>Data Mapper</em> have come to dominate.</p></div><div class="foil-notes"><div class="foilinset"><p>Data persistence used to mean constructing SQL queries by hand and 
        executing <code class="code">SELECT</code>, <code class="code">INSERT</code>, or <code class="code">UPDATE</code>
        queries directly from your web app controller.</p><p>More recently, persistence patterns which remove the responsibility
        for writing SQL have emerged.</p><p>Martin Fowler covered several of these in his book [<span class="citation">Patterns of Enterprise Application Architecture</span>].</p><p>Two of those, <em>Active Record</em> and <em>Data Mapper</em> have come to dominate.</p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">8</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Active Record</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.</p></div><div class="foil-notes"><div class="foilinset"><p>An object that wraps a row in a database table or view, encapsulates the database access, and adds domain logic on that data.</p></div><div class="speakernotes">
        <p>PoEAA p160</p>
        <p>The high level summary: An object which knows how to save, retrieve, and find itself in the DB. Requires that the DB and object schemas are in lockstep. The Rails' framework's ActiveRecord library is perhaps the best known implementation.</p>
      </div></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">9</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Data Mapper</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>A layer of Mappers that moves data between objects and a database while keeping them independent of each other and the mapper itself.</p><p>Mapper: An object that sets up a communication between two independent objects</p></div><div class="foil-notes"><div class="foilinset"><p>A layer of Mappers that moves data between objects and a database while keeping them independent of each other and the mapper itself.</p><p>Mapper: An object that sets up a communication between two independent objects</p></div><div class="speakernotes">
        <p>PoEAA p165, p473</p>
        <p>The high level summary: More abstract than Active Record, here the mapping between DB and Object is made explicit and separated from the objects that get created into a Mapper (or Mappers). Hibernate is probably the best known implementor of this pattern.</p>
      </div></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">10</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Setting up DataMapper (the library)</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>We're going to be using the Ruby library DataMapper to bridge between database and objects. 
        As it's name suggests, it was inspired by the Data Mapper pattern. In actual fact it ends up being
        a bit of a cross between Active Record and Data Mapper, but it does make the mapping between DB and
        Object explicit.</p></div><div class="foil-notes"><div class="foilinset"><p>We're going to be using the Ruby library DataMapper to bridge between database and objects. 
        As it's name suggests, it was inspired by the Data Mapper pattern. In actual fact it ends up being
        a bit of a cross between Active Record and Data Mapper, but it does make the mapping between DB and
        Object explicit.</p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">11</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Adding to the Gemfile</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>If you don't already have DataMapper listed in the Gemfile for your app it needs to be added:</p><div class="programlisting highlight"><pre class="ruby"><span class="c1"># ./Gemfile</span>
<span class="n">source</span> <span class="s1">'http://rubygems.org/'</span>

<span class="n">gem</span> <span class="s1">'sinatra'</span><span class="p">,</span> <span class="s1">'~&gt; 1.3'</span>
<span class="n">gem</span> <span class="s1">'nokogiri'</span>
<span class="n">gem</span> <span class="s1">'data_mapper'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2'</span>
<span class="n">gem</span> <span class="s1">'dm-sqlite-adapter'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2.0'</span></pre></div><p><code class="code">Gemfile</code></p></div><div class="foil-notes"><div class="foilinset"><p>If you don't already have DataMapper listed in the Gemfile for your app it needs to be added:</p><div class="programlisting highlight"><pre class="ruby"><span class="c1"># ./Gemfile</span>
<span class="n">source</span> <span class="s1">'http://rubygems.org/'</span>

<span class="n">gem</span> <span class="s1">'sinatra'</span><span class="p">,</span> <span class="s1">'~&gt; 1.3'</span>
<span class="n">gem</span> <span class="s1">'nokogiri'</span>
<span class="n">gem</span> <span class="s1">'data_mapper'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2'</span>
<span class="n">gem</span> <span class="s1">'dm-sqlite-adapter'</span><span class="p">,</span> <span class="s1">'~&gt; 1.2.0'</span></pre></div><p><code class="code">Gemfile</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">12</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Adding the setup code to the app</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="ruby"><span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="nb">require</span> <span class="s1">'data_mapper'</span>

<span class="no">ROOT_DIR</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../../'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>

<span class="c1"># Classes which use DataMapper MUST be required </span>
<span class="c1"># before this point.</span>
<span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'db/annotated_shakespeare.db'</span><span class="p">,</span> 
                        <span class="no">ROOT_DIR</span><span class="p">)</span>
<span class="no">DataMapper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="s2">"sqlite://</span><span class="si">#{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="no">DataMapper</span><span class="o">.</span><span class="n">auto_upgrade!</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="ruby"><span class="c1"># encoding: utf-8</span>

<span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="nb">require</span> <span class="s1">'data_mapper'</span>

<span class="no">ROOT_DIR</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'../../'</span><span class="p">,</span> <span class="bp">__FILE__</span><span class="p">)</span>

<span class="c1"># Classes which use DataMapper MUST be required </span>
<span class="c1"># before this point.</span>
<span class="n">path</span> <span class="o">=</span> <span class="no">File</span><span class="o">.</span><span class="n">expand_path</span><span class="p">(</span><span class="s1">'db/annotated_shakespeare.db'</span><span class="p">,</span> 
                        <span class="no">ROOT_DIR</span><span class="p">)</span>
<span class="no">DataMapper</span><span class="o">.</span><span class="n">setup</span><span class="p">(</span><span class="ss">:default</span><span class="p">,</span> <span class="s2">"sqlite://</span><span class="si">#{</span><span class="n">db_path</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>

<span class="no">DataMapper</span><span class="o">.</span><span class="n">auto_upgrade!</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">13</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Defining the Comment model</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="ruby"><span class="nb">require</span> <span class="s1">'data_mapper'</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>

  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span>
  <span class="n">property</span> <span class="ss">:body</span><span class="p">,</span> <span class="no">Text</span>
<span class="k">end</span></pre></div><p><code class="code">lib/comment.rb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="ruby"><span class="nb">require</span> <span class="s1">'data_mapper'</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>

  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span>
  <span class="n">property</span> <span class="ss">:body</span><span class="p">,</span> <span class="no">Text</span>
<span class="k">end</span></pre></div><p><code class="code">lib/comment.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">14</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Creating the database</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>We're using SQLite, so the database is automatically created for us, and
        the call to <code class="code">DataMapper::auto_upgrade!</code> generates tables
        based on our model</p></div><div class="foil-notes"><div class="foilinset"><p>We're using SQLite, so the database is automatically created for us, and
        the call to <code class="code">DataMapper::auto_upgrade!</code> generates tables
        based on our model</p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">15</div></div></div><div class="foil titlefoil foilgroup"><div class="page"><div class="header"><h1>POSTing data back to the app</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">16</div></div></div><div class="foil"><div class="page"><div class="header"><h1>HTML forms</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="html+erb"><span class="cp">&lt;%=</span> <span class="vi">@act</span><span class="o">.</span><span class="n">html</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"comments"</span><span class="nt">&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">url</span><span class="p">(</span><span class="s2">"/plays/</span><span class="si">#{</span><span class="vi">@play</span><span class="o">.</span><span class="n">slug</span><span class="si">}</span><span class="s2">/act/</span>
<span class="s2">                      </span><span class="si">#{</span><span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">/comments"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span> 
      <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"comment[body]"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add comment"</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/section&gt;</span></pre></div><p><code class="code">views/show.erb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="html+erb"><span class="cp">&lt;%=</span> <span class="vi">@act</span><span class="o">.</span><span class="n">html</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"comments"</span><span class="nt">&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">url</span><span class="p">(</span><span class="s2">"/plays/</span><span class="si">#{</span><span class="vi">@play</span><span class="o">.</span><span class="n">slug</span><span class="si">}</span><span class="s2">/act/</span>
<span class="s2">                      </span><span class="si">#{</span><span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">/comments"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span> 
      <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"comment[body]"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add comment"</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/form&gt;</span>
<span class="nt">&lt;/section&gt;</span></pre></div><p><code class="code">views/show.erb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">17</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Nested params</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>Rack translates forms like this:</p><div class="programlisting highlight"><pre class="html+erb"><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"thing[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Kermit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"thing[colour]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Green"</span><span class="nt">&gt;</span></pre></div><p>Into a <code class="code">params</code> hash like this:</p><div class="programlisting highlight"><pre class="ruby"><span class="p">{</span>
  <span class="s2">"thing"</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Kermit"</span><span class="p">,</span>
    <span class="s2">"colour"</span> <span class="o">=&gt;</span> <span class="s2">"Green"</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></div><div class="foil-notes"><div class="foilinset"><p>Rack translates forms like this:</p><div class="programlisting highlight"><pre class="html+erb"><span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"thing[name]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Kermit"</span><span class="nt">&gt;</span>
<span class="nt">&lt;input</span> <span class="na">name=</span><span class="s">"thing[colour]"</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">value=</span><span class="s">"Green"</span><span class="nt">&gt;</span></pre></div><p>Into a <code class="code">params</code> hash like this:</p><div class="programlisting highlight"><pre class="ruby"><span class="p">{</span>
  <span class="s2">"thing"</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="s2">"name"</span> <span class="o">=&gt;</span> <span class="s2">"Kermit"</span><span class="p">,</span>
    <span class="s2">"colour"</span> <span class="o">=&gt;</span> <span class="s2">"Green"</span>
  <span class="p">}</span>
<span class="p">}</span></pre></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">18</div></div></div><div class="foil titlefoil foilgroup"><div class="page"><div class="header"><h1>Processing POST data</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">19</div></div></div><div class="foil"><div class="page"><div class="header"><h1>The <code class="code">params</code> hash</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>The <code class="code">params</code> hash contains all the data passed to our app in a request:</p><div class="itemizedlist"><ul><li><p>Route segments</p></li><li><p>Query string params (also GET form data)</p></li><li><p>POSTed form data</p></li></ul></div><p>For example, given the route <code class="code">/plays/:id/act/:act_number</code> POSTing the previous form to <code class="code">/plays/caesar/act/1</code> would yield a params hash like:</p><div class="programlisting highlight"><pre class="ruby"><span class="p">{</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s2">"caesar"</span><span class="p">,</span> <span class="s1">'act_number'</span> <span class="o">=&gt;</span> <span class="s2">"1"</span><span class="p">,</span>
 <span class="s1">'thing'</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s2">"Kermit"</span><span class="p">,</span> <span class="s1">'colour'</span> <span class="o">=&gt;</span> <span class="s2">"Green"</span><span class="p">}}</span></pre></div></div><div class="foil-notes"><div class="foilinset"><p>The <code class="code">params</code> hash contains all the data passed to our app in a request:</p><div class="itemizedlist"><ul><li><p>Route segments</p></li><li><p>Query string params (also GET form data)</p></li><li><p>POSTed form data</p></li></ul></div><p>For example, given the route <code class="code">/plays/:id/act/:act_number</code> POSTing the previous form to <code class="code">/plays/caesar/act/1</code> would yield a params hash like:</p><div class="programlisting highlight"><pre class="ruby"><span class="p">{</span><span class="s1">'id'</span> <span class="o">=&gt;</span> <span class="s2">"caesar"</span><span class="p">,</span> <span class="s1">'act_number'</span> <span class="o">=&gt;</span> <span class="s2">"1"</span><span class="p">,</span>
 <span class="s1">'thing'</span> <span class="o">=&gt;</span> <span class="p">{</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="s2">"Kermit"</span><span class="p">,</span> <span class="s1">'colour'</span> <span class="o">=&gt;</span> <span class="s2">"Green"</span><span class="p">}}</span></pre></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">20</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Using the params hash</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>You get to the params hash using the <code class="code">params</code> method in your app.</p><div class="programlisting highlight"><pre class="ruby"><span class="n">get</span> <span class="s2">"/act/:id"</span> <span class="k">do</span>
  <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="s1">'id'</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></pre></div></div><div class="foil-notes"><div class="foilinset"><p>You get to the params hash using the <code class="code">params</code> method in your app.</p><div class="programlisting highlight"><pre class="ruby"><span class="n">get</span> <span class="s2">"/act/:id"</span> <span class="k">do</span>
  <span class="s2">"Hello, </span><span class="si">#{</span><span class="n">params</span><span class="o">[</span><span class="s1">'id'</span><span class="o">]</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span></pre></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">21</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Creating a Comment</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="ruby"><span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="nb">require</span> <span class="s1">'play'</span>
<span class="nb">require</span> <span class="s1">'data_mapper'</span>
<span class="nb">require</span> <span class="s1">'comment'</span>

<span class="k">class</span> <span class="nc">AnnotatedShakespeare</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">post</span> <span class="s1">'/plays/:id/act/:act_number/comments'</span> <span class="k">do</span>
    <span class="vi">@play</span> <span class="o">=</span> <span class="no">Play</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@act</span> <span class="o">=</span> <span class="vi">@play</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:act_number</span><span class="o">]</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s1">'comment'</span><span class="o">][</span><span class="s1">'body'</span><span class="o">]</span><span class="p">)</span>
    <span class="n">erb</span> <span class="ss">:show</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="ruby"><span class="nb">require</span> <span class="s1">'sinatra/base'</span>
<span class="nb">require</span> <span class="s1">'play'</span>
<span class="nb">require</span> <span class="s1">'data_mapper'</span>
<span class="nb">require</span> <span class="s1">'comment'</span>

<span class="k">class</span> <span class="nc">AnnotatedShakespeare</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">post</span> <span class="s1">'/plays/:id/act/:act_number/comments'</span> <span class="k">do</span>
    <span class="vi">@play</span> <span class="o">=</span> <span class="no">Play</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@act</span> <span class="o">=</span> <span class="vi">@play</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:act_number</span><span class="o">]</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s1">'comment'</span><span class="o">][</span><span class="s1">'body'</span><span class="o">]</span><span class="p">)</span>
    <span class="n">erb</span> <span class="ss">:show</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">22</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Creating a Comment - associating with an Act</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="ruby"><span class="nb">require</span> <span class="s1">'data_mapper'</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>

  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span>
  <span class="n">property</span> <span class="ss">:body</span><span class="p">,</span> <span class="no">Text</span>

  <span class="n">property</span> <span class="ss">:commentable_type</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">property</span> <span class="ss">:commentable_id</span><span class="p">,</span> <span class="nb">String</span>
<span class="k">end</span></pre></div><p><code class="code">lib/comment.rb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="ruby"><span class="nb">require</span> <span class="s1">'data_mapper'</span>

<span class="k">class</span> <span class="nc">Comment</span>
  <span class="kp">include</span> <span class="no">DataMapper</span><span class="o">::</span><span class="no">Resource</span>

  <span class="n">property</span> <span class="ss">:id</span><span class="p">,</span> <span class="no">Serial</span>
  <span class="n">property</span> <span class="ss">:body</span><span class="p">,</span> <span class="no">Text</span>

  <span class="n">property</span> <span class="ss">:commentable_type</span><span class="p">,</span> <span class="nb">String</span>
  <span class="n">property</span> <span class="ss">:commentable_id</span><span class="p">,</span> <span class="nb">String</span>
<span class="k">end</span></pre></div><p><code class="code">lib/comment.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">23</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Creating a Comment for an Act</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">AnnotatedShakespeare</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">post</span> <span class="s1">'/plays/:id/act/:act_number/comments'</span> <span class="k">do</span>
    <span class="vi">@play</span> <span class="o">=</span> <span class="no">Play</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@act</span> <span class="o">=</span> <span class="vi">@play</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:act_number</span><span class="o">]</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s1">'comment'</span><span class="o">][</span><span class="s1">'body'</span><span class="o">]</span><span class="p">,</span> 
                    <span class="ss">:commentable_type</span> <span class="o">=&gt;</span> <span class="ss">:act</span><span class="p">,</span> 
                    <span class="ss">:commentable_id</span> <span class="o">=&gt;</span> <span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="n">erb</span> <span class="ss">:show</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">AnnotatedShakespeare</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">post</span> <span class="s1">'/plays/:id/act/:act_number/comments'</span> <span class="k">do</span>
    <span class="vi">@play</span> <span class="o">=</span> <span class="no">Play</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@act</span> <span class="o">=</span> <span class="vi">@play</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:act_number</span><span class="o">]</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s1">'comment'</span><span class="o">][</span><span class="s1">'body'</span><span class="o">]</span><span class="p">,</span> 
                    <span class="ss">:commentable_type</span> <span class="o">=&gt;</span> <span class="ss">:act</span><span class="p">,</span> 
                    <span class="ss">:commentable_id</span> <span class="o">=&gt;</span> <span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="n">erb</span> <span class="ss">:show</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">24</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Redirecting</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>Rendering the Act show view after creation opens us up to replay: reloading the page will simply create a duplicate comment.</p><p>After methods that mutate the state of the system, we should issue an HTTP redirect to somewhere sensible (In this case, to the Act URL)</p><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">AnnotatedShakespeare</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">post</span> <span class="s1">'/plays/:id/act/:act_number/comments'</span> <span class="k">do</span>
    <span class="vi">@play</span> <span class="o">=</span> <span class="no">Play</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@act</span> <span class="o">=</span> <span class="vi">@play</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:act_number</span><span class="o">]</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s1">'comment'</span><span class="o">][</span><span class="s1">'body'</span><span class="o">]</span><span class="p">,</span> 
                    <span class="ss">:commentable_type</span> <span class="o">=&gt;</span> <span class="ss">:act</span><span class="p">,</span> 
                    <span class="ss">:commentable_id</span> <span class="o">=&gt;</span> <span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s2">"/plays/</span><span class="si">#{</span><span class="vi">@play</span><span class="o">.</span><span class="n">slug</span><span class="si">}</span><span class="s2">/act/</span><span class="si">#{</span><span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><div class="foil-notes"><div class="foilinset"><p>Rendering the Act show view after creation opens us up to replay: reloading the page will simply create a duplicate comment.</p><p>After methods that mutate the state of the system, we should issue an HTTP redirect to somewhere sensible (In this case, to the Act URL)</p><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">AnnotatedShakespeare</span> <span class="o">&lt;</span> <span class="no">Sinatra</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">post</span> <span class="s1">'/plays/:id/act/:act_number/comments'</span> <span class="k">do</span>
    <span class="vi">@play</span> <span class="o">=</span> <span class="no">Play</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:id</span><span class="o">]</span><span class="p">)</span>
    <span class="vi">@act</span> <span class="o">=</span> <span class="vi">@play</span><span class="o">.</span><span class="n">act</span><span class="p">(</span><span class="n">params</span><span class="o">[</span><span class="ss">:act_number</span><span class="o">]</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">create!</span><span class="p">(</span><span class="ss">:body</span> <span class="o">=&gt;</span> <span class="n">params</span><span class="o">[</span><span class="s1">'comment'</span><span class="o">][</span><span class="s1">'body'</span><span class="o">]</span><span class="p">,</span> 
                    <span class="ss">:commentable_type</span> <span class="o">=&gt;</span> <span class="ss">:act</span><span class="p">,</span> 
                    <span class="ss">:commentable_id</span> <span class="o">=&gt;</span> <span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="p">)</span>
    <span class="n">redirect</span> <span class="n">to</span><span class="p">(</span><span class="s2">"/plays/</span><span class="si">#{</span><span class="vi">@play</span><span class="o">.</span><span class="n">slug</span><span class="si">}</span><span class="s2">/act/</span><span class="si">#{</span><span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/annotated_shakespeare.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">25</div></div></div><div class="foil titlefoil foilgroup"><div class="page"><div class="header"><h1>Displaying the results</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">26</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Showing Comments</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><p>Let's add comments to the end of the Act page</p><div class="itemizedlist"><ul><li><p>How do we fetch comments for a page?</p></li><li><p>How do we get them into the view?</p></li></ul></div></div><div class="foil-notes"><div class="foilinset"><p>Let's add comments to the end of the Act page</p><div class="itemizedlist"><ul><li><p>How do we fetch comments for a page?</p></li><li><p>How do we get them into the view?</p></li></ul></div></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">27</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Fetching comments</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><a href="javascript:clicknav('next')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></a></div><div class="foil-body"><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">Comment</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">for</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:commentable_type</span> <span class="o">=&gt;</span> <span class="n">type</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
                <span class="ss">:commentable_id</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/comment.rb</code></p><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">Act</span>
  <span class="k">def</span> <span class="nf">comments</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:act</span><span class="p">,</span> <span class="vi">@number</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/act.rb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">Comment</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">for</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="nb">id</span><span class="p">)</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="ss">:commentable_type</span> <span class="o">=&gt;</span> <span class="n">type</span><span class="o">.</span><span class="n">to_s</span><span class="p">,</span>
                <span class="ss">:commentable_id</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="o">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/comment.rb</code></p><div class="programlisting highlight"><pre class="ruby"><span class="k">class</span> <span class="nc">Act</span>
  <span class="k">def</span> <span class="nf">comments</span>
    <span class="no">Comment</span><span class="o">.</span><span class="n">for</span><span class="p">(</span><span class="ss">:act</span><span class="p">,</span> <span class="vi">@number</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div><p><code class="code">lib/act.rb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">28</div></div></div><div class="foil"><div class="page"><div class="header"><h1>Getting comments into the page</h1></div><div class="body"><div class="clicknav"><a href="javascript:clicknav('prev')"><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Prev]" /></a><img src="http://docbook.github.com/release/2.0.3/base/../slides/img/transparent.gif" alt="[Next]" /></div><div class="foil-body"><div class="programlisting highlight"><pre class="html+erb"><span class="cp">&lt;%=</span> <span class="vi">@act</span><span class="o">.</span><span class="n">html</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"comments"</span><span class="nt">&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">url</span><span class="p">(</span><span class="s2">"/plays/</span><span class="si">#{</span><span class="vi">@play</span><span class="o">.</span><span class="n">slug</span><span class="si">}</span><span class="s2">/act/</span>
<span class="s2">                      </span><span class="si">#{</span><span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">/comments"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span> 
      <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"comment[body]"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add comment"</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/form&gt;</span>

  <span class="cp">&lt;%</span> <span class="vi">@comments</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"comment"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">comment</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/section&gt;</span></pre></div><p><code class="code">views/show.erb</code></p></div><div class="foil-notes"><div class="foilinset"><div class="programlisting highlight"><pre class="html+erb"><span class="cp">&lt;%=</span> <span class="vi">@act</span><span class="o">.</span><span class="n">html</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;section</span> <span class="na">id=</span><span class="s">"comments"</span><span class="nt">&gt;</span>
<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">"</span><span class="cp">&lt;%=</span> <span class="n">url</span><span class="p">(</span><span class="s2">"/plays/</span><span class="si">#{</span><span class="vi">@play</span><span class="o">.</span><span class="n">slug</span><span class="si">}</span><span class="s2">/act/</span>
<span class="s2">                      </span><span class="si">#{</span><span class="vi">@act</span><span class="o">.</span><span class="n">number</span><span class="si">}</span><span class="s2">/comments"</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="s">"</span> 
      <span class="na">charset=</span><span class="s">"utf-8"</span> <span class="na">method=</span><span class="s">"POST"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;textarea</span> <span class="na">name=</span><span class="s">"comment[body]"</span><span class="nt">&gt;&lt;/textarea&gt;</span>
    <span class="nt">&lt;p&gt;&lt;input</span> <span class="na">type=</span><span class="s">"submit"</span> <span class="na">value=</span><span class="s">"Add comment"</span><span class="nt">&gt;&lt;/p&gt;</span>
  <span class="nt">&lt;/form&gt;</span>

  <span class="cp">&lt;%</span> <span class="vi">@comments</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">comment</span><span class="o">|</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"comment"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">comment</span><span class="o">.</span><span class="n">body</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="nt">&lt;/section&gt;</span></pre></div><p><code class="code">views/show.erb</code></p></div><p>No speaker notes for this foil.</p></div></div></div><div class="footer"><div class="license">Licensed under a Creative Commons Attribution-
  <br />Noncommercial-Share Alike 3.0 Unported License</div><div class="content">www.xmlsummerschool.com</div><div class="foilnumber">29</div></div></div></body></html>