<?dbhtml pygments="true"?>
<slides xml:lang="en" xmlns="http://docbook.org/ns/docbook"
  xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink">
  <info>
    <title>Practical Web Applications</title>
    <subtitle>Session Three</subtitle>
    <!-- authors are alphabetical by first name (I get sick of being listed last all the time, 
so I always do this if I can) -->
    <authorgroup>
      <author>
        <personname>
          <firstname>Lauren</firstname>
          <surname>Wood</surname>
        </personname>
        <affiliation>
          <orgname>Textuality Services, Inc.</orgname>
        </affiliation>
      </author>
      <author>
        <personname>
          <firstname>Matt</firstname>
          <surname>Patterson</surname>
        </personname>
        <affiliation>
          <orgname>Constituent Parts, Ltd.</orgname>
        </affiliation>
      </author>
      <author>
        <personname>
          <firstname>Norman </firstname>
          <surname>Walsh</surname>
        </personname>
        <affiliation>
          <orgname>MarkLogic</orgname>
        </affiliation>
      </author>
      <author>
        <personname>
          <firstname>Paul</firstname>
          <surname>Downey</surname>
        </personname>
        <affiliation>
          <orgname>Whatfettle</orgname>
        </affiliation>
      </author>
    </authorgroup>
    <releaseinfo role="version">Version 1.0</releaseinfo>
    <legalnotice>
      <para>Alpha by first name</para>
    </legalnotice>
    <pubdate>2012-09-20</pubdate>
    <copyright>
      <year>2012</year>
      <holder>Lauren Wood, Matt Patterson, Norm Walsh, Paul Downey</holder>
    </copyright>
  </info>
  <foilgroup>
    <title>Modelling Plays for our app</title>
    <foil>
      <title>What's in a play?</title>
      <para>Let's consider what the most basic parts of the play are:</para>
      <itemizedlist>
        <listitem>
          <para>The title of the play</para>
        </listitem>
        <listitem>
          <para>Who wrote it</para>
        </listitem>
        <listitem>
          <para>How it's broken up into acts and scenes</para>
        </listitem>
        <listitem>
          <para>Characters</para>
        </listitem>
        <listitem>
          <para>The text itself</para>
        </listitem>
      </itemizedlist>
      <para>What does the data we have make easier for us?</para>
      <speakernotes>
        <para>Before we begin just blindly throwing things around, we should stop and consider
          what data we actually have to hand, how it's structured, what we want from it, and
          how easy it is to get things out of it.</para>
        <para>The play XML gives us some things twice, like the title and author. We need to
          pick one, but it's pretty clear what they are.</para>
        <para>The structure of the play is less clear, because the markup is primarily aimed
          at preserving the printed characteristics of the manuscript. If we look closely
          we can see that although there are no explicit 'Act' or 'Scene' elements the &lt;head&gt;
          element is only used to mark the title of the play (its third appearance) and 
          what look like Act or Scene titles.</para>
        <para>Characters are called out, but just as strings: not with ID refs or anything 
          unambiguous. For ease, I think we'll have to ignore those.</para>
        <para>The XML contains element and text content for all the various bits of metadata 
          and elizabethan typesetting notes, but the play's text is unambigously within the
          &lt;text&gt; element, and the metadata's all outside that, so that's alright.</para>
      </speakernotes>
    </foil>
    <foil>
      <title>The simplest possible Play &amp; Act objects</title>
      <para>After looking at it, the simplest useful data model probably looks like this:</para>
      <itemizedlist>
        <listitem>
          <para>The play</para>
          <itemizedlist>
            <listitem>
              <para>The title</para>
            </listitem>
            <listitem>
              <para>The author</para>
            </listitem>
          </itemizedlist>
        </listitem>
        <listitem>
          <para>An act</para>
          <itemizedlist>
            <listitem>
              <para>Act number</para>
            </listitem>
            <listitem>
              <para>Title</para>
            </listitem>
            <listitem>
              <para>Act text</para>
            </listitem>
          </itemizedlist>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>As Ruby</title>
      <programlisting language="ruby"><xi:include href="ex/simplest_models.rb" parse="text"/></programlisting>
    </foil>
  </foilgroup>
  <foilgroup>
    <title>Designing the URLs</title>
    <foil>
      <title>What resources are there?</title>
      <para>At first glance</para>
      <itemizedlist>
        <listitem>
          <para>Play</para>
        </listitem>
        <listitem>
          <para>Act</para>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>How should they be exposed?</title>
      <para>We actually need more than we thought</para>
      <itemizedlist>
        <listitem>
          <para>A list of all Plays</para>
        </listitem>
        <listitem>
          <para>An individual Play</para>
        </listitem>
        <listitem>
          <para>An Act of a Play</para>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>The URLs</title>
      <itemizedlist>
        <listitem>
          <para><code>/</code></para>
        </listitem>
        <listitem>
          <para><code>/plays/caesar</code></para>
        </listitem>
        <listitem>
          <para><code>/plays/caesar/act/1</code></para>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>Routing in Sinatra</title>
      <programlisting language="ruby"><xi:include href="ex/base_routes.rb" parse="text"/></programlisting>
      <speakernotes>
        <para>Sinatra uses methods named for HTTP methods to declare routes.</para>
        <para>These are all GET routes. The <code>:param_name</code> sections in the URL 
          patterns are placeholders for variable parts of the URL, e.g. <code>/plays/caesar</code>
          or <code>/plays/hamlet</code> will both match <code>get "/plays/:id"</code>, and
          <code>caesar</code> or <code>hamlet</code> will be accessible as a parameter named
          <code>:id</code>.</para>
      </speakernotes>
    </foil>
    <foil>
      <title>Holes in the URI space</title>
      <para>With the holes that leaves in the URL space, we probably also need:</para>
      <itemizedlist>
        <listitem>
          <para><code>/plays</code></para>
        </listitem>
        <listitem>
          <para><code>/plays/:id/act</code></para>
        </listitem>
      </itemizedlist>
      <speakernotes>
        <para>Before we add these extra routes in, it's worth trying out the first set.</para>
        <para>If you were to put the URL <code>/plays/caesar/act/1</code> in to your browser
          and start to hack off chunks of the URL then you'll see 404s at
          <code>/plays/caesar/act</code> and <code>/plays</code>.</para>
        <para>These extra routes avoid that by redirecting the browser to the next level up</para>
      </speakernotes>
    </foil>
    <foil>
      <title>Routing in Sinatra</title>
      <programlisting language="ruby"><xi:include href="ex/routes_plus_redirects.rb" parse="text"/></programlisting>
    </foil>
  </foilgroup>
  <foilgroup>
    <title>Extracting data from the Play XML with Nokogiri</title>
    <foil>
      <title>Extracting the Play and Act titles</title>
      <para>Nokogiri provides with a Ruby API around the GNOME libxml2 library.</para>
      <para>The Ruby API is nice and easy to use:</para>
      <programlisting language="ruby"><xi:include href="ex/nokogiri-css_and_xpath_search.rb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>The Play object</title>
      <para>Let's revisit the Play class and actually extract the data</para>
      <programlisting language="ruby"><xi:include href="ex/nokogiri-play_with_title.rb" parse="text"/></programlisting>
    </foil>
  </foilgroup>
  <foilgroup>
    <title>Generating HTML for an Act using XSLT</title>
    <foil>
      <title>Running an XSLT</title>
      <para>Nokogiri is also a wrapper around GNOME libxslt1.1.</para>
      <programlisting language="ruby"><xi:include href="ex/nokogiri-xslt.rb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>The Act object</title>
      <programlisting language="ruby"><xi:include href="ex/nokogiri-act_with_data.rb" parse="text"/></programlisting>
    </foil>
  </foilgroup>
  <foilgroup>
    <title>Wiring everything together</title>
    <foil>
      <title>Generating a page listing Plays</title>
      <para>What do we need?</para>
      <itemizedlist>
        <listitem>
          <para>HTML template</para>
        </listitem>
        <listitem>
          <para>Ability to find all the Plays</para>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>HTML template</title>
      <programlisting language="erb"><xi:include href="ex/plays-index.erb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>Finding all the plays</title>
      <programlisting language="ruby"><xi:include href="ex/get-all-plays-controller.rb" parse="text"/></programlisting>
      <programlisting language="ruby"><xi:include href="ex/get-all-plays-model.rb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>Listing a Play's Acts</title>
      <para>What do we need?</para>
      <itemizedlist>
        <listitem>
          <para>Ability to generate a unique URL slug for a Play</para>
        </listitem>
        <listitem>
          <para>HTML template</para>
        </listitem>
        <listitem>
          <para>Ability to get a Play object</para>
        </listitem>
        <listitem>
          <para>Ability to work out what Acts a Play has</para>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>Generating a unique URL slug for a Play</title>
      <programlisting language="ruby"><xi:include href="ex/play-url_slug.rb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>HTML template</title>
      <programlisting language="erb"><xi:include href="ex/play-show.erb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>Getting a Play</title>
      <programlisting language="ruby"><xi:include href="ex/get-play-model.rb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>What Acts does a Play have?</title>
      <programlisting language="ruby"><xi:include href="ex/play-get-acts-model.rb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>Showing a whole Act</title>
      <para>What do we need?</para>
      <itemizedlist>
        <listitem>
          <para>HTML template</para>
        </listitem>
        <listitem>
          <para>Ability to get an Act object</para>
        </listitem>
      </itemizedlist>
    </foil>
    <foil>
      <title>HTML template</title>
      <programlisting language="erb"><xi:include href="ex/act-show.erb" parse="text"/></programlisting>
    </foil>
    <foil>
      <title>Getting an Act</title>
      <programlisting language="ruby"><xi:include href="ex/get-act-controller.rb" parse="text"/></programlisting>
    </foil>
  </foilgroup>
</slides>

